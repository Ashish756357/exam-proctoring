services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: exam
      POSTGRES_PASSWORD: exam
      POSTGRES_DB: exam_portal
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  mongo:
    image: mongo:7
    volumes:
      - mongo_data:/data/db
    ports:
      - "27017:27017"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  ai-engine:
    build:
      context: ../ai-engine
      dockerfile: Dockerfile
    ports:
      - "8090:8090"

  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    environment:
      NODE_ENV: production
      PORT: ${BACKEND_PORT:-8080}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173,http://localhost:5174,http://localhost:5175}
      DATABASE_URL: ${DATABASE_URL:-postgresql://exam:exam@postgres:5432/exam_portal}
      MONGO_URL: ${MONGO_URL:-mongodb://mongo:27017/exam_portal}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:-change_me_access}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-change_me_refresh}
      JWT_MOBILE_SECRET: ${JWT_MOBILE_SECRET:-change_me_mobile}
      ACCESS_TOKEN_TTL_SECONDS: ${ACCESS_TOKEN_TTL_SECONDS:-900}
      REFRESH_TOKEN_TTL_SECONDS: ${REFRESH_TOKEN_TTL_SECONDS:-1209600}
      PAIRING_TOKEN_TTL_SECONDS: ${PAIRING_TOKEN_TTL_SECONDS:-300}
      SESSION_HEARTBEAT_TIMEOUT_SECONDS: ${SESSION_HEARTBEAT_TIMEOUT_SECONDS:-20}
      VIOLATION_AUTOSUBMIT_THRESHOLD: ${VIOLATION_AUTOSUBMIT_THRESHOLD:-100}
      AI_ENGINE_URL: ${AI_ENGINE_URL:-http://ai-engine:8090}
      MOBILE_APP_BASE_URL: ${MOBILE_APP_BASE_URL:-http://localhost:5174}
      ENCRYPTION_KEY_HEX: ${ENCRYPTION_KEY_HEX:-0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef}
    command: ["sh", "-c", "npx prisma generate && npx prisma db push && npm run start"]
    depends_on:
      - postgres
      - mongo
      - redis
      - ai-engine
    ports:
      - "8080:8080"

  candidate-app:
    build:
      context: ../apps/candidate
      dockerfile: Dockerfile
      args:
        VITE_API_BASE: ${VITE_API_BASE:-}
        VITE_WS_BASE: ${VITE_WS_BASE:-}
        VITE_ICE_SERVERS_JSON: ${VITE_ICE_SERVERS_JSON:-}
    ports:
      - "5173:5173"

  mobile-app:
    build:
      context: ../apps/mobile
      dockerfile: Dockerfile
      args:
        VITE_API_BASE: ${VITE_API_BASE:-}
        VITE_WS_BASE: ${VITE_WS_BASE:-}
        VITE_ICE_SERVERS_JSON: ${VITE_ICE_SERVERS_JSON:-}
    ports:
      - "5174:5174"

  admin-app:
    build:
      context: ../apps/admin
      dockerfile: Dockerfile
      args:
        VITE_API_BASE: ${VITE_API_BASE:-}
        VITE_WS_BASE: ${VITE_WS_BASE:-}
        VITE_ICE_SERVERS_JSON: ${VITE_ICE_SERVERS_JSON:-}
    ports:
      - "5175:5175"

  reverse-proxy:
    image: nginx:1.27-alpine
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend
      - candidate-app
      - mobile-app
      - admin-app
    ports:
      - "80:80"

volumes:
  postgres_data:
  mongo_data:
